# 视频生成链路优化建议（不降音质、不影响观看）

## 1. 目标与范围

目标：在不降低音质、不影响观看体验的前提下，尽量提升视频生成速度并减少输出体积。  
范围：根目录与 `worktree-funasr` 下全部脚本。

已检查脚本：
- `/Users/haland/Desktop/video/process.sh`
- `/Users/haland/Desktop/video/transcribe.py`
- `/Users/haland/Desktop/video/trim_videos.sh`
- `/Users/haland/Desktop/video/add_number.sh`
- `/Users/haland/Desktop/video/worktree-funasr/process.sh`
- `/Users/haland/Desktop/video/worktree-funasr/transcribe.py`
- `/Users/haland/Desktop/video/worktree-funasr/trim_videos.sh`
- `/Users/haland/Desktop/video/worktree-funasr/add_number.sh`
- `/Users/haland/Desktop/video/worktree-funasr/benchmark_asr.sh`
- `/Users/haland/Desktop/video/worktree-funasr/prefetch_funasr_models.sh`
- `/Users/haland/Desktop/video/worktree-funasr/setup_funasr_env.sh`

---

## 2. 当前实现评估

### 已经做对的点

1. 主导出采用“静态封面 + 原音频 + 字幕烧录”路线，视频编码压力已大幅降低。  
2. 优先使用 `h264_videotoolbox`，在 Apple Silicon 上有明显提速。  
3. 输出 `OUTPUT_FPS=2`，符合静态画面用途。  
4. 音频采用 `-c:a copy`（主流程），可保证音质不下降且省时。

### 主要瓶颈

1. **ASR（语音识别）耗时**：长视频批处理时是首要耗时项。  
2. **重复转码**：`add_number.sh` 会对最终视频再做一次完整视频编码。  
3. **无效重复识别**：已有字幕时仍会重跑识别。  
4. **裁剪脚本 copy 模式仍有可优化空间**：`-ss` 位置可提速。

---

## 3. 优化建议（按优先级）

## P0（建议优先落地）

### 3.1 默认识别引擎切到 FunASR，并调大批处理窗口

涉及：
- `/Users/haland/Desktop/video/worktree-funasr/process.sh:11`
- `/Users/haland/Desktop/video/worktree-funasr/transcribe.py:76`

建议：
1. 默认 `ASR_ENGINE=funasr`。  
2. `FUNASR_BATCH_SIZE_S` 从默认 `300` 提升到 `480` 或 `600`（M4 先测 600）。

预期：
- 识别阶段总时长明显下降。

说明：
- 不改变音频流，不影响最终音质。

### 3.2 已有字幕则跳过 ASR

涉及：
- `/Users/haland/Desktop/video/process.sh`
- `/Users/haland/Desktop/video/worktree-funasr/process.sh`

建议：
1. 在 `process_video()` 内先判断：若 `output/srt/<name>.srt` 与 `output/srt/<name>.ass` 均存在，则跳过识别，直接导出。  
2. 增加可选开关（例如 `FORCE_ASR=1`）用于强制重跑识别。

预期：
- 对重试任务、补导出任务可节省大量时间。

### 3.3 合并“加编号”到主导出，避免二次全量转码

涉及：
- `/Users/haland/Desktop/video/add_number.sh:42`
- `/Users/haland/Desktop/video/worktree-funasr/add_number.sh:40`

现状：
- `add_number.sh` 对 `_final.mp4` 再次 `libx264` 编码，形成二次转码。

建议：
1. 在主导出 `ffmpeg` 的同一条滤镜链中同时做 `ass` 与 `drawtext`（按需启用）。  
2. 保留 `add_number.sh` 作为兼容脚本，但默认改为调用主导出逻辑而不是独立二次编码。

预期：
- 明显减少总时长与 I/O。  
- 避免不必要的再次编码导致体积与时间增加。

### 3.4 裁剪 copy 模式前置 `-ss`

涉及：
- `/Users/haland/Desktop/video/trim_videos.sh:62`
- `/Users/haland/Desktop/video/worktree-funasr/trim_videos.sh:64`

建议：
- copy 模式改为：`ffmpeg -y -ss START -to END -i SRC -c copy ...`

预期：
- 长视频裁剪更快。

---

## P1（次优先，主要减体积）

### 3.5 增加 HEVC 硬编选项

涉及：
- `/Users/haland/Desktop/video/process.sh:21`
- `/Users/haland/Desktop/video/worktree-funasr/process.sh:28`

建议：
1. 自动检测并支持 `hevc_videotoolbox`。  
2. 通过环境变量选择：`VIDEO_CODEC=h264|hevc`（默认 h264，便于兼容）。

预期：
- 静态画面场景下，HEVC 通常可进一步减小体积，观看体验基本不变。

### 3.6 减少导出滤镜开销

涉及：
- `/Users/haland/Desktop/video/process.sh:86-87`
- `/Users/haland/Desktop/video/worktree-funasr/process.sh:194-195`

建议：
1. 将 `-loop 1` 输入改为 `-framerate ${OUTPUT_FPS}`。  
2. 视频滤镜从 `fps=...,ass=...` 调整为仅 `ass=...`。

预期：
- 轻微提速，逻辑更直接。

### 3.7 修正 `--export` 对字幕文件的检查条件

涉及：
- `/Users/haland/Desktop/video/process.sh`
- `/Users/haland/Desktop/video/worktree-funasr/process.sh`

现状：
- `--export` 检查 `.srt` 是否存在，但实际导出依赖 `.ass`。

建议：
- 改为优先检查 `.ass`（必要时缺失就报错/跳过），避免无效尝试。

---

## 4. 参数建议（可直接执行）

### 常规批处理（推荐）

```bash
ASR_ENGINE=funasr \
FUNASR_BATCH_SIZE_S=600 \
VIDEO_ENCODER=h264_videotoolbox \
OUTPUT_FPS=2 \
./process.sh --all
```

### 仅导出（已有字幕）

```bash
VIDEO_ENCODER=h264_videotoolbox OUTPUT_FPS=2 ./process.sh --export
```

### 体积优先测试（兼容性可接受时）

```bash
VIDEO_ENCODER=hevc_videotoolbox OUTPUT_FPS=2 ./process.sh --export
```

---

## 5. 执行顺序建议

1. 先落地 P0：3.1 / 3.2 / 3.3 / 3.4。  
2. 然后做 P1：3.5 / 3.6 / 3.7。  
3. 使用 `worktree-funasr/benchmark_asr.sh` 对比 ASR 用时，记录 RTF。  
4. 以 2~3 个典型样本验证最终体积与观看体验。

---

## 6. 风险与回退

1. FunASR 默认化后，首次需确认本地模型缓存完整；可先运行：  
   - `/Users/haland/Desktop/video/worktree-funasr/prefetch_funasr_models.sh`
2. HEVC 的播放器兼容性需在目标平台抽样验证。  
3. 对每项优化保留环境变量开关，出现异常可快速回退到原参数。

---

## 7. 预估收益（定性）

1. ASR 切 FunASR + batch 提升：整体流程常见可见级提速。  
2. 跳过已有字幕识别：重复任务耗时显著下降。  
3. 合并加编号到主导出：减少一次完整重编码与磁盘读写。  
4. HEVC（可选）：在静态画面任务中可进一步降低体积。

